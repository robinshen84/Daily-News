<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æŠ¥è‡ªåŠ¨ç”Ÿæˆå™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-text: #2c3e50;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 16px;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 1rem auto;
            max-width: 1200px;
            overflow: hidden;
        }

        /* æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                font-size: 18px;
            }
            
            .main-container {
                margin: 0.5rem;
                border-radius: 15px;
                max-width: none;
            }
        }

        /* å¹³æ¿ç«¯ä¼˜åŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .main-container {
                max-width: 900px;
            }
        }

        /* æ‰‹æœºç«¯è¡¨å•ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* å¢å¤§è¡¨å•å…ƒç´ å­—ä½“ */
            .form-control, .form-select, .btn {
                font-size: 1rem;
            }
            
            .form-label {
                font-size: 1.1rem;
                font-weight: 500;
            }
            
            .color-theme-card {
                padding: 0.8rem;
            }
            
            .tag-option {
                padding: 0.8rem 0.5rem;
                font-size: 0.9rem;
            }
            
            textarea.form-control {
                font-size: 1rem;
                line-height: 1.5;
            }
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        /* æ‰‹æœºç«¯å¤´éƒ¨ä¼˜åŒ– */
        @media (max-width: 768px) {
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header p {
                font-size: 1rem;
            }
        }

        .content {
            padding: 2rem;
        }

        .form-section {
            background: var(--light-bg);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        /* æ‰‹æœºç«¯å†…å®¹åŒºåŸŸä¼˜åŒ– */
        @media (max-width: 768px) {
            .content {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1rem;
                margin-bottom: 1.5rem;
                border-radius: 10px;
            }
            
            .form-section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }
        }

        .color-theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 0.8rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #fafafa;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .color-theme-grid::-webkit-scrollbar {
            width: 6px;
        }

        .color-theme-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .color-theme-grid::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .color-theme-grid::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* æ‰‹æœºç«¯é¢œè‰²ä¸»é¢˜ç½‘æ ¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .color-theme-grid {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: 0.6rem;
                max-height: 400px;
                padding: 0.6rem;
            }
        }

        /* æ–°é—»æ ¼å¼é€‰æ‹©å™¨æ ·å¼ */
        .format-option {
            position: relative;
            margin-bottom: 0;
        }

        .format-option input[type="radio"] {
            display: none;
        }

        .format-label {
            display: block;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            height: 100%;
            margin: 0;
        }

        .format-label:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.1);
        }

        .format-option input[type="radio"]:checked + .format-label {
            border-color: #007bff;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(0,123,255,0.2);
        }

        .format-option input[type="radio"]:checked + .format-label .format-example {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
        }

        .format-label i {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .format-label strong {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }

        .format-label small {
            display: block;
            margin-bottom: 0.5rem;
            opacity: 0.8;
            font-size: 0.8rem;
        }

        .format-example {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* æ‰‹æœºç«¯æ ¼å¼é€‰æ‹©å™¨ä¼˜åŒ– */
        @media (max-width: 768px) {
            .format-label {
                padding: 0.8rem;
            }
            
            .format-label i {
                font-size: 1.2rem;
            }
            
            .format-label strong {
                font-size: 0.9rem;
            }
            
            .format-label small {
                font-size: 0.75rem;
            }
            
            .format-example {
                font-size: 0.7rem;
                padding: 0.4rem;
            }
        }

        .color-theme-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .color-theme-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--secondary-color);
        }

        .color-theme-card.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .color-theme-card.selected::after {
            content: "âœ“";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--secondary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .color-preview {
            height: 50px;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .color-preview::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
        }

        .logo-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo-upload-area:hover {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.05);
        }

        .logo-upload-area.dragover {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }

        .logo-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            margin: 1rem auto;
            display: none;
        }

        .news-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .news-item .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .preview-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid #e9ecef;
        }

        .preview-iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
        }

        .btn-primary {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            padding: 0.75rem 2rem;
            font-weight: 500;
        }

        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            padding: 0.75rem 2rem;
            font-weight: 500;
        }

        /* æ‰‹æœºç«¯æŒ‰é’®ä¼˜åŒ– */
        @media (max-width: 768px) {
            .btn-primary, .btn-success, .btn-outline-primary, .btn-outline-secondary {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                width: 100%;
                margin-bottom: 0.5rem;
            }
            
            .text-center .btn-primary,
            .text-center .btn-success {
                width: auto;
                min-width: 160px;
            }
        }

        .btn-outline-primary {
            color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .tag-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tag-option {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .tag-option:hover {
            background-color: #f8f9fa;
        }

        .tag-option.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-newspaper"></i> æ—¥æŠ¥è‡ªåŠ¨ç”Ÿæˆå™¨ v2.0</h1>
            <p>è½»æ¾åˆ›å»ºä¸“ä¸šçš„æ—¥æŠ¥ï¼Œæ”¯æŒæ™ºèƒ½è§£æå’Œä¸€é”®ç”Ÿæˆå›¾ç‰‡</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 1rem;">
                <i class="fas fa-code"></i> æ­¤åº”ç”¨ç”±é è°±ç“¦å”åˆ¶ä½œ
            </p>
        </div>

        <div class="content">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="form-section">
                <h3><i class="fas fa-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h3>
                <div class="row">
                    <div class="col-md-6">
                        <label for="reportName" class="form-label">æ—¥æŠ¥åç§°</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="reportName" placeholder="è¯·è¾“å…¥æ—¥æŠ¥åç§°">
                            <span class="input-group-text">æ—¥æŠ¥</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label for="signature" class="form-label">ç­¾å/æ ‡è¯­</label>
                        <input type="text" class="form-control" id="signature" 
                               value="ç²¾å¿ƒç­–å±•ï¼Œé«˜æ•ˆä¼ è¾¾ - æ´å¯Ÿç§‘æŠ€æœªæ¥" 
                               placeholder="è¯·è¾“å…¥ç­¾åæˆ–æ ‡è¯­">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showCreator" checked>
                            <label class="form-check-label" for="showCreator">
                                <i class="fas fa-user-tag"></i> åœ¨æ—¥æŠ¥ä¸­æ˜¾ç¤ºåˆ¶ä½œè€…ä¿¡æ¯
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logoä¸Šä¼  -->
            <div class="form-section">
                <h3><i class="fas fa-image"></i> Logoè®¾ç½®</h3>
                <div class="logo-upload-area" id="logoUploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p class="text-muted">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Logoå›¾ç‰‡</p>
                    <p class="small text-muted">æ”¯æŒ PNG, JPG, JPEG, GIF, WEBP æ ¼å¼</p>
                    <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    <img class="logo-preview" id="logoPreview" alt="Logoé¢„è§ˆ">
                </div>
            </div>

            <!-- é¢œè‰²ä¸»é¢˜ -->
            <div class="form-section">
                <h3><i class="fas fa-palette"></i> é¢œè‰²ä¸»é¢˜</h3>
                <p class="text-muted mb-3">
                    <i class="fas fa-sparkles"></i> 
                    é€‰æ‹©æ‚¨å–œæ¬¢çš„é¢œè‰²ä¸»é¢˜ï¼ŒåŒ…å«è‹¹æœé£æ ¼æŸ”å’Œé…è‰²ã€ç²¾ç¾æ¸å˜å’Œå•†åŠ¡é…è‰²ï¼Œæ‰“é€ ä¸“ä¸šè€Œèˆ’é€‚çš„è§†è§‰ä½“éªŒ
                </p>
                <div class="color-theme-grid">
                    {% for theme_id, theme in color_themes.items() %}
                    <div class="color-theme-card" data-theme="{{ theme_id }}">
                        <div class="color-preview" style="background: {{ theme.header_gradient }};"></div>
                        <strong>{{ theme.name }}</strong>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="mt-3">
                    <h5>è‡ªå®šä¹‰é¢œè‰²</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">ä¸»è‰²è°ƒ</label>
                            <input type="color" class="form-control form-control-color" id="customPrimary" value="#2c3e50">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">æ¬¡è‰²è°ƒ</label>
                            <input type="color" class="form-control form-control-color" id="customSecondary" value="#34495e">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">å¼ºè°ƒè‰²</label>
                            <input type="color" class="form-control form-control-color" id="customAccent" value="#e74c3c">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary mt-4" id="useCustomColors">
                                ä½¿ç”¨è‡ªå®šä¹‰é¢œè‰²
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ–°é—»å†…å®¹ -->
            <div class="form-section">
                <h3><i class="fas fa-list"></i> æ–°é—»å†…å®¹</h3>
                
                <!-- æ‰¹é‡å¯¼å…¥åŒºåŸŸ -->
                <div class="mb-4">
                    <h5><i class="fas fa-magic"></i> æ™ºèƒ½è§£æ <span class="badge bg-success">å‡çº§ç‰ˆ</span></h5>
                    <p class="text-muted">
                        <strong>ğŸš€ å…¨æ–°å‡çº§ï¼</strong> æ”¯æŒå¤šç§æ–°é—»æ ¼å¼æ™ºèƒ½è§£æï¼š<br>
                        âœ… è‡ªåŠ¨ç§»é™¤æ ‡é¢˜å’Œç¼–å·<br>
                        âœ… æ™ºèƒ½åˆ†ç¦»æ ‡é¢˜å’Œå†…å®¹<br>
                        âœ… è‡ªåŠ¨è¯†åˆ«å…¬å¸åç§°å’Œæ–°é—»ç±»å‹æ ‡ç­¾
                    </p>
                    
                    <!-- æ–°é—»æ ¼å¼é€‰æ‹© -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-newspaper"></i> é€‰æ‹©æ–°é—»æ ¼å¼
                        </label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="format-option" data-format="ai">
                                    <input type="radio" id="formatAI" name="newsFormat" value="ai" checked>
                                    <label for="formatAI" class="format-label">
                                        <i class="fas fa-robot"></i>
                                        <strong>AIæ–°é—»æ ¼å¼</strong>
                                        <small>ç¼–å·åˆ—è¡¨æ ¼å¼ï¼Œé€‚åˆAIã€ç§‘æŠ€èµ„è®¯</small>
                                        <div class="format-example">
                                            1. é˜¿é‡Œå·´å·´å‘å¸ƒæ–°æ¨¡å‹ï¼Œæå‡è¯†åˆ«å‡†ç¡®ç‡...
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="format-option" data-format="general">
                                    <input type="radio" id="formatGeneral" name="newsFormat" value="general">
                                    <label for="formatGeneral" class="format-label">
                                        <i class="fas fa-globe"></i>
                                        <strong>ç»¼åˆæ–°é—»æ ¼å¼</strong>
                                        <small>æ ‡é¢˜:å†…å®¹æ ¼å¼ï¼Œé€‚åˆæ—¶æ”¿ã€è´¢ç»</small>
                                        <div class="format-example">
                                            ç‰¹æœ—æ™®æŠµè¾¾è‹±å›½è¿›è¡Œå›½äº‹è®¿é—®:ç‰¹æœ—æ™®ä»Šå¤©...
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <textarea class="form-control mb-3" id="bulkNewsInput" rows="8" 
                              placeholder="è¯·æ ¹æ®é€‰æ‹©çš„æ ¼å¼ç²˜è´´æ–°é—»å†…å®¹ï¼š&#10;&#10;ã€AIæ–°é—»æ ¼å¼ã€‘&#10;AIæ—©æŠ¥ 2025å¹´09æœˆ17æ—¥&#10;1. é˜¿é‡Œå·´å·´å‘å¸ƒç«¯åˆ°ç«¯è¯­éŸ³è¯†åˆ«å¤§æ¨¡å‹...&#10;2. è…¾è®¯æ­£å¼å‘å¸ƒæ··å…ƒ3D 3.0æ¨¡å‹...&#10;&#10;ã€ç»¼åˆæ–°é—»æ ¼å¼ã€‘&#10;ç‰¹æœ—æ™®æŠµè¾¾è‹±å›½è¿›è¡Œå›½äº‹è®¿é—®:ç‰¹æœ—æ™®ä»Šå¤©æŠµè¾¾è‹±å›½ï¼Œä¸å¤«äººä¸€åŒä¸‹é£æœº...&#10;ç¾è‚¡æ”¶ç›˜ç™¾åº¦å¤§æ¶¨è¶…7%:åœ¨ç¾å›½è‚¡å¸‚ä¸­ï¼Œç™¾åº¦è‚¡ç¥¨æ”¶ç›˜ä¸Šæ¶¨è¶…è¿‡7%..."></textarea>
                    <button type="button" class="btn btn-primary" id="parseNewsBtn">
                        <i class="fas fa-magic"></i> æ™ºèƒ½è§£ææ–°é—»
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" id="clearAllNews">
                        <i class="fas fa-trash"></i> æ¸…ç©ºæ‰€æœ‰
                    </button>
                </div>
                
                <hr>
                
                <div id="newsItems">
                    <!-- æ–°é—»æ¡ç›®å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
                <button type="button" class="btn btn-outline-primary" id="addNewsItem">
                    <i class="fas fa-plus"></i> æ‰‹åŠ¨æ·»åŠ æ–°é—»
                </button>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="text-center">
                <button type="button" class="btn btn-primary me-3" id="generatePreview">
                    <i class="fas fa-eye"></i> ç”Ÿæˆé¢„è§ˆ
                </button>
                <button type="button" class="btn btn-success" id="exportImage" disabled>
                    <i class="fas fa-download"></i> å¯¼å‡ºå›¾ç‰‡
                </button>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-3">æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...</p>
            </div>

            <!-- é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-section" id="previewSection" style="display: none;">
                <h3><i class="fas fa-eye"></i> é¢„è§ˆ</h3>
                <iframe class="preview-iframe" id="previewIframe"></iframe>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentLogo = '';
        let currentTheme = 'classic';
        let newsItemCount = 0;
        let generatedHtml = '';

        // æ–°é—»æ ‡ç­¾æ•°æ®
        const newsTags = {{ news_tags | tojson }};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupLogoUpload();
            setupColorThemes();
            setupNewsManagement();
            setupPreviewGeneration();
            setupImageExport();
            
            // ç¡®ä¿æ™ºèƒ½è§£æåŒºåŸŸæ˜¾ç¤º
            console.log('æ™ºèƒ½è§£æåŠŸèƒ½å·²åŠ è½½');
            
            // è®¾ç½®æ–°é—»æ ¼å¼åˆ‡æ¢äº‹ä»¶
            setupNewsFormatToggle();
        }

        // Logoä¸Šä¼ åŠŸèƒ½
        function setupLogoUpload() {
            setupLogoUploadEvents();
        }

        // è®¾ç½®Logoä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¯å¤ç”¨ï¼‰
        function setupLogoUploadEvents() {
            const uploadArea = document.getElementById('logoUploadArea');
            const fileInput = document.getElementById('logoInput');

            if (!uploadArea) {
                console.error('Logoä¸Šä¼ åŒºåŸŸæœªæ‰¾åˆ°');
                return;
            }

            // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            uploadArea.removeEventListener('click', logoClickHandler);
            uploadArea.removeEventListener('dragover', logoDragOverHandler);
            uploadArea.removeEventListener('dragleave', logoDragLeaveHandler);
            uploadArea.removeEventListener('drop', logoDropHandler);
            if (fileInput) {
                fileInput.removeEventListener('change', logoChangeHandler);
            }

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            uploadArea.addEventListener('click', logoClickHandler);
            uploadArea.addEventListener('dragover', logoDragOverHandler);
            uploadArea.addEventListener('dragleave', logoDragLeaveHandler);
            uploadArea.addEventListener('drop', logoDropHandler);
            if (fileInput) {
                fileInput.addEventListener('change', logoChangeHandler);
            }
        }

        // äº‹ä»¶å¤„ç†å‡½æ•°
        function logoClickHandler() {
            const fileInput = document.getElementById('logoInput');
            if (fileInput) {
                fileInput.click();
            }
        }

        function logoDragOverHandler(e) {
                e.preventDefault();
            const uploadArea = document.getElementById('logoUploadArea');
                uploadArea.classList.add('dragover');
        }

        function logoDragLeaveHandler() {
            const uploadArea = document.getElementById('logoUploadArea');
                uploadArea.classList.remove('dragover');
        }

        function logoDropHandler(e) {
                e.preventDefault();
            const uploadArea = document.getElementById('logoUploadArea');
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
        }

        function logoChangeHandler(e) {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
        }

        function handleFileUpload(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼æ”¯æŒæ ¼å¼ï¼šPNGã€JPGã€JPEGã€GIFã€WEBP');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (16MB)
            if (file.size > 16 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡16MBï¼');
                return;
            }

            // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
            const uploadArea = document.getElementById('logoUploadArea');
            uploadArea.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ä¸Šä¼ ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨ä¸Šä¼ Logo...</p>
                </div>
            `;

            const formData = new FormData();
            formData.append('logo', file);

            fetch('/upload_logo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentLogo = data.data;
                    
                    // æ›´æ–°ä¸Šä¼ åŒºåŸŸï¼Œä¿æŒå¯ç‚¹å‡»çŠ¶æ€
                    const uploadArea = document.getElementById('logoUploadArea');
                    uploadArea.innerHTML = `
                        <img src="${currentLogo}" class="logo-preview" id="logoPreview" style="display: block; max-width: 100px; max-height: 100px; margin: 0 auto; border-radius: 50%; object-fit: cover;">
                        <p class="text-success mt-2"><i class="fas fa-check-circle"></i> Logoä¸Šä¼ æˆåŠŸï¼</p>
                        <p class="small text-muted">ç‚¹å‡»é‡æ–°ä¸Šä¼ æ›´æ¢Logo</p>
                        <input type="file" id="logoInput" accept="image/*" style="display: none;">
                    `;
                    
                    // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    setupLogoUploadEvents();
                } else {
                    alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.error);
                    // æ¢å¤ä¸Šä¼ åŒºåŸŸåˆ°åˆå§‹çŠ¶æ€
                    restoreUploadArea();
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                // æ¢å¤ä¸Šä¼ åŒºåŸŸåˆ°åˆå§‹çŠ¶æ€
                restoreUploadArea();
            });
        }

        // æ¢å¤ä¸Šä¼ åŒºåŸŸåˆ°åˆå§‹çŠ¶æ€
        function restoreUploadArea() {
            const uploadArea = document.getElementById('logoUploadArea');
            uploadArea.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ Logoå›¾ç‰‡</p>
                <p class="small text-muted">æ”¯æŒ PNG, JPG, JPEG, GIF, WEBP æ ¼å¼</p>
                <input type="file" id="logoInput" accept="image/*" style="display: none;">
                <img class="logo-preview" id="logoPreview" alt="Logoé¢„è§ˆ" style="display: none;">
            `;
            
            // é‡æ–°è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupLogoUploadEvents();
        }

        // é¢œè‰²ä¸»é¢˜åŠŸèƒ½
        function setupColorThemes() {
            const themeCards = document.querySelectorAll('.color-theme-card');
            const customButton = document.getElementById('useCustomColors');

            themeCards.forEach(card => {
                card.addEventListener('click', () => {
                    themeCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    currentTheme = card.dataset.theme;
                });
            });

            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªä¸»é¢˜
            themeCards[0].classList.add('selected');

            customButton.addEventListener('click', () => {
                themeCards.forEach(c => c.classList.remove('selected'));
                currentTheme = 'custom';
            });
        }

        // æ–°é—»ç®¡ç†åŠŸèƒ½
        function setupNewsManagement() {
            document.getElementById('addNewsItem').addEventListener('click', addNewsItem);
            document.getElementById('parseNewsBtn').addEventListener('click', parseNewsContent);
            document.getElementById('clearAllNews').addEventListener('click', clearAllNews);
        }

        function addNewsItem() {
            newsItemCount++;
            const container = document.getElementById('newsItems');
            
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            newsItem.dataset.index = newsItemCount;
            
            newsItem.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeNewsItem(${newsItemCount})">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" class="form-control news-title" 
                               placeholder="è¯·è¾“å…¥æ–°é—»æ ‡é¢˜">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">å…¬å¸/æœºæ„</label>
                        <input type="text" class="form-control news-company" 
                               placeholder="è¯·è¾“å…¥å…¬å¸åç§°">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-control news-description" rows="3" 
                              placeholder="è¯·è¾“å…¥æ–°é—»æè¿°"></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">æ ‡ç­¾ç±»å‹</label>
                    <div class="tag-selector">
                        ${Object.entries(newsTags).map(([key, tag]) => 
                            `<div class="tag-option" data-tag="${key}">
                                <i class="fas ${tag.icon}"></i> ${tag.name}
                             </div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            container.appendChild(newsItem);
            
            // è®¾ç½®æ ‡ç­¾é€‰æ‹©å™¨
            const tagOptions = newsItem.querySelectorAll('.tag-option');
            tagOptions.forEach(option => {
                option.addEventListener('click', () => {
                    tagOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ ‡ç­¾
            tagOptions[0].classList.add('selected');
        }

        function removeNewsItem(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
            }
        }

        // è§£ææ–°é—»å†…å®¹
        function parseNewsContent() {
            const bulkInput = document.getElementById('bulkNewsInput');
            const content = bulkInput.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥æ–°é—»å†…å®¹');
                return;
            }

            // é¢„å¤„ç†å†…å®¹ï¼šç§»é™¤æ ‡é¢˜è¡Œå’Œæ ¼å¼åŒ–
            let processedContent = preprocessContent(content);

            // æŒ‰è¡Œåˆ†å‰²æ–°é—»
            const newsLines = processedContent.split('\n').filter(line => line.trim());
            
            // æ¸…ç©ºç°æœ‰æ–°é—»
            clearAllNews();
            
            let successCount = 0;
            newsLines.forEach(line => {
                const parsedNews = parseNewsLine(line.trim());
                if (parsedNews) {
                    addNewsItemWithData(parsedNews);
                    successCount++;
                }
            });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            bulkInput.value = '';
            
            alert(`æˆåŠŸè§£æ ${successCount} æ¡æ–°é—»ï¼`);
        }

        // é¢„å¤„ç†å†…å®¹ï¼šç§»é™¤æ ‡é¢˜ã€ç¼–å·ç­‰
        function preprocessContent(content) {
            let lines = content.split('\n');
            let processedLines = [];
            
            for (let line of lines) {
                line = line.trim();
                
                // è·³è¿‡ç©ºè¡Œ
                if (!line) continue;
                
                // è·³è¿‡æ ‡é¢˜è¡Œï¼ˆå¦‚ï¼šAIæ—©æŠ¥ 2025å¹´09æœˆ16æ—¥ï¼‰
                if (isHeaderLine(line)) {
                    console.log('è·³è¿‡æ ‡é¢˜è¡Œ:', line);
                    continue;
                }
                
                // å¤„ç†ç¼–å·æ–°é—»ï¼ˆå¦‚ï¼š1. æ–°é—»å†…å®¹ï¼‰
                const cleanedLine = removeNumberPrefix(line);
                if (cleanedLine) {
                    processedLines.push(cleanedLine);
                }
            }
            
            return processedLines.join('\n');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºæ ‡é¢˜è¡Œ
        function isHeaderLine(line) {
            // åŒ¹é…å„ç§æ ‡é¢˜æ ¼å¼
            const headerPatterns = [
                /^.*æ—©æŠ¥.*\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥.*$/,    // AIæ—©æŠ¥ 2025å¹´09æœˆ16æ—¥
                /^.*æ—¥æŠ¥.*\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥.*$/,    // ç§‘æŠ€æ—¥æŠ¥ 2025å¹´09æœˆ16æ—¥
                /^.*å¿«è®¯.*\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥.*$/,    // å¿«è®¯ 2025å¹´09æœˆ16æ—¥
                /^.*\d{4}-\d{1,2}-\d{1,2}.*$/,             // 2025-09-16 æ ¼å¼
                /^.*\d{1,2}\/\d{1,2}\/\d{4}.*$/,           // 09/16/2025 æ ¼å¼
                /^ã€.*ã€‘.*$/,                               // ã€æ ‡é¢˜ã€‘æ ¼å¼
                /^.*æ–°é—».*æ±‡æ€».*$/,                         // æ–°é—»æ±‡æ€»
                /^.*èµ„è®¯.*æ±‡æ€».*$/,                         // èµ„è®¯æ±‡æ€»
                /^ä»Šæ—¥.*$/,                                 // ä»Šæ—¥å¼€å¤´
                /^.*æ‘˜è¦.*$/                                // æ‘˜è¦
            ];
            
            return headerPatterns.some(pattern => pattern.test(line));
        }

        // ç§»é™¤ç¼–å·å‰ç¼€
        function removeNumberPrefix(line) {
            // åŒ¹é…å„ç§ç¼–å·æ ¼å¼
            const numberPatterns = [
                /^(\d+)[\.\ã€‚]\s*(.+)$/,           // 1. å†…å®¹ æˆ– 1ã€‚å†…å®¹
                /^(\d+)[\)ï¼‰]\s*(.+)$/,           // 1) å†…å®¹ æˆ– 1ï¼‰å†…å®¹
                /^ã€\d+ã€‘\s*(.+)$/,               // ã€1ã€‘å†…å®¹
                /^ï¼ˆ\d+ï¼‰\s*(.+)$/,               // ï¼ˆ1ï¼‰å†…å®¹
                /^[ï¼ˆ\(]\d+[ï¼‰\)]\s*(.+)$/        // (1)å†…å®¹ æˆ– ï¼ˆ1ï¼‰å†…å®¹
            ];
            
            for (let pattern of numberPatterns) {
                const match = line.match(pattern);
                if (match) {
                    return match[match.length - 1].trim(); // è¿”å›æœ€åä¸€ä¸ªæ•è·ç»„ï¼ˆå†…å®¹éƒ¨åˆ†ï¼‰
                }
            }
            
            return line; // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ç¼–å·æ ¼å¼ï¼Œè¿”å›åŸå†…å®¹
        }

        // è®¾ç½®æ–°é—»æ ¼å¼åˆ‡æ¢åŠŸèƒ½
        function setupNewsFormatToggle() {
            const formatRadios = document.querySelectorAll('input[name="newsFormat"]');
            const textarea = document.getElementById('bulkNewsInput');
            
            const placeholders = {
                'ai': 'è¯·ç²˜è´´AIæ–°é—»æ ¼å¼å†…å®¹ï¼š\n\nAIæ—©æŠ¥ 2025å¹´09æœˆ17æ—¥\n\n1. é˜¿é‡Œå·´å·´é€šä¹‰å®éªŒå®¤å‘å¸ƒç«¯åˆ°ç«¯è¯­éŸ³è¯†åˆ«å¤§æ¨¡å‹FunAudio-ASRï¼Œæå‡é«˜å™ªå£°ç¯å¢ƒè¯†åˆ«å‡†ç¡®ç‡ï¼Œé™ä½å¹»è§‰ã€‚\n\n2. è…¾è®¯æ­£å¼å‘å¸ƒæ··å…ƒ3D 3.0æ¨¡å‹ï¼Œå»ºæ¨¡ç²¾åº¦æå‡3å€ï¼Œå‡ ä½•åˆ†è¾¨ç‡è¾¾1536Â³ï¼Œæ”¯æŒ36äº¿ä½“ç´ è¶…é«˜æ¸…å»ºæ¨¡ã€‚\n\n3. å­—èŠ‚è·³åŠ¨ä¸é¦™æ¸¯å¤§å­¦è”åˆæ¨å‡ºå¼€æºè§†è§‰æ¨ç†æ¨¡å‹Mini-o3...',
                'general': 'è¯·ç²˜è´´ç»¼åˆæ–°é—»æ ¼å¼å†…å®¹ï¼š\n\nç‰¹æœ—æ™®æŠµè¾¾è‹±å›½è¿›è¡Œå›½äº‹è®¿é—®:ç‰¹æœ—æ™®ä»Šå¤©æŠµè¾¾è‹±å›½ï¼Œä¸å¤«äººä¸€åŒä¸‹é£æœºï¼Œå±•å¼€å›½äº‹è®¿é—®ï¼Œå¼•å‘æ°‘ä¼—æŠ—è®®æ´»åŠ¨ã€‚\n\nç‰¹æœ—æ™®åˆ°è®¿è‹±å›½å¼•å‘æ°‘ä¼—æŠ—è®®:ç‰¹æœ—æ™®çš„è‹±å›½è®¿é—®å¼•å‘å¤§é‡æŠ—è®®è€…èšé›†ï¼Œå±•ç¤ºå¯¹ä»–çš„æ”¿æ²»ç«‹åœºçš„ä¸æ»¡ã€‚\n\nä»¥å†›å‘è·å°è¾¾æ¸¯å±…æ°‘å‘å‡ºç´§æ€¥æ’¤ç¦»è­¦å‘Š:ä»¥è‰²åˆ—å†›æ–¹å·²å‘å‡ºè­¦å‘Šï¼Œè¦æ±‚åœ¨ä¹Ÿé—¨è·å°è¾¾æ¸¯çš„å±…æ°‘ç´§æ€¥æ’¤ç¦»ã€‚\n\nç¾è‚¡æ”¶ç›˜ç™¾åº¦å¤§æ¶¨è¶…7%:åœ¨ç¾å›½è‚¡å¸‚ä¸­ï¼Œç™¾åº¦è‚¡ç¥¨æ”¶ç›˜ä¸Šæ¶¨è¶…è¿‡7%ï¼Œå—å¸‚åœºå…³æ³¨ã€‚'
            };
            
            // è®¾ç½®åˆå§‹placeholder
            if (textarea) {
                const selectedFormat = getSelectedNewsFormat();
                textarea.placeholder = placeholders[selectedFormat];
            }
            
            // ä¸ºæ¯ä¸ªå•é€‰æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            formatRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked && textarea) {
                        textarea.placeholder = placeholders[this.value];
                        console.log('åˆ‡æ¢åˆ°æ–°é—»æ ¼å¼:', this.value);
                    }
                });
            });
        }

        // è·å–é€‰ä¸­çš„æ–°é—»æ ¼å¼
        function getSelectedNewsFormat() {
            const formatRadios = document.querySelectorAll('input[name="newsFormat"]');
            for (let radio of formatRadios) {
                if (radio.checked) {
                    return radio.value;
                }
            }
            return 'ai'; // é»˜è®¤ä¸ºAIæ ¼å¼
        }

        // è§£æå•æ¡æ–°é—»
        function parseNewsLine(line) {
            if (!line || line.length < 10) return null;
            
            const newsFormat = getSelectedNewsFormat();
            let title = '';
            let description = '';
            let company = '';
            let tag = 'tech'; // é»˜è®¤æ ‡ç­¾
            
            if (newsFormat === 'general') {
                // ç»¼åˆæ–°é—»æ ¼å¼è§£æ
                const parsed = parseGeneralNewsFormat(line);
                title = parsed.title;
                description = parsed.description;
            } else {
                // AIæ–°é—»æ ¼å¼è§£æï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                const parsed = intelligentTitleContentSplit(line);
                title = parsed.title;
                description = parsed.description;
            }
            
            // æå–å…¬å¸åç§°
            company = extractCompanyName(line);
            
            // æ™ºèƒ½æ¨æµ‹æ ‡ç­¾
            tag = predictTag(line);
            
            return {
                title: title,
                description: description,
                company: company,
                tag: tag
            };
        }

        // è§£æç»¼åˆæ–°é—»æ ¼å¼ï¼ˆæ ‡é¢˜:å†…å®¹ï¼‰
        function parseGeneralNewsFormat(line) {
            // ç»¼åˆæ–°é—»æ ¼å¼ï¼šæ ‡é¢˜:å†…å®¹
            // ä¾‹å¦‚ï¼šç‰¹æœ—æ™®æŠµè¾¾è‹±å›½è¿›è¡Œå›½äº‹è®¿é—®:ç‰¹æœ—æ™®ä»Šå¤©æŠµè¾¾è‹±å›½ï¼Œä¸å¤«äººä¸€åŒä¸‹é£æœºï¼Œå±•å¼€å›½äº‹è®¿é—®ï¼Œå¼•å‘æ°‘ä¼—æŠ—è®®æ´»åŠ¨ã€‚
            
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå†’å·ä½œä¸ºåˆ†éš”ç¬¦
            const colonIndex = line.indexOf(':');
            const chineseColonIndex = line.indexOf('ï¼š');
            
            let splitIndex = -1;
            if (colonIndex > 0 && chineseColonIndex > 0) {
                // å¦‚æœä¸¤ç§å†’å·éƒ½å­˜åœ¨ï¼Œé€‰æ‹©è¾ƒå‰é¢çš„é‚£ä¸ª
                splitIndex = Math.min(colonIndex, chineseColonIndex);
            } else if (colonIndex > 0) {
                splitIndex = colonIndex;
            } else if (chineseColonIndex > 0) {
                splitIndex = chineseColonIndex;
            }
            
            if (splitIndex > 0 && splitIndex < line.length - 10) { // ç¡®ä¿å†’å·åé¢è¿˜æœ‰è¶³å¤Ÿçš„å†…å®¹
                const title = line.substring(0, splitIndex).trim();
                const description = line.substring(splitIndex + 1).trim();
                
                // éªŒè¯æ ‡é¢˜å’Œå†…å®¹éƒ½æœ‰æ„ä¹‰çš„é•¿åº¦
                if (title.length >= 5 && description.length >= 10) {
                    return {
                        title: title,
                        description: description
                    };
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„å†’å·åˆ†å‰²ï¼Œå°è¯•å…¶ä»–åˆ†å‰²æ–¹æ³•
            // æ–¹æ³•2: æŸ¥æ‰¾å¥å·åˆ†å‰²ç‚¹ï¼ˆç¬¬ä¸€å¥ä½œä¸ºæ ‡é¢˜ï¼‰
            const sentences = line.split(/[ã€‚ï¼ï¼Ÿ\.!?]/);
            if (sentences.length >= 2 && sentences[0].length > 5 && sentences[0].length < 50) {
                const title = sentences[0].trim();
                const description = sentences.slice(1).join('').trim();
                if (description.length > 5) {
                    return {
                        title: title,
                        description: description
                    };
                }
            }
            
            // æ–¹æ³•3: æ ¹æ®é•¿åº¦æ™ºèƒ½åˆ†å‰²
            if (line.length > 30) {
                // æ‰¾åˆ°ä¸­é—´ä½ç½®é™„è¿‘çš„åˆé€‚åˆ†å‰²ç‚¹
                const midPoint = Math.floor(line.length * 0.4); // 40%çš„ä½ç½®
                let splitPoint = midPoint;
                
                // åœ¨ä¸­é—´ä½ç½®é™„è¿‘å¯»æ‰¾åˆé€‚çš„åˆ†å‰²ç‚¹ï¼ˆé€—å·ã€å¥å·ç­‰ï¼‰
                for (let i = midPoint - 10; i <= midPoint + 20 && i < line.length; i++) {
                    if (line[i] === 'ï¼Œ' || line[i] === ',' || line[i] === 'ã€‚' || line[i] === 'ï¼š' || line[i] === ':') {
                        splitPoint = i;
                        break;
                    }
                }
                
                const title = line.substring(0, splitPoint).trim();
                const description = line.substring(splitPoint + 1).trim();
                
                if (title.length >= 5 && description.length >= 5) {
                    return {
                        title: title,
                        description: description
                    };
                }
            }
            
            // é»˜è®¤å¤„ç†ï¼šå¦‚æœå†…å®¹è¾ƒçŸ­ï¼Œå…¨éƒ¨ä½œä¸ºæ ‡é¢˜
            if (line.length <= 30) {
                return {
                    title: line.trim(),
                    description: 'è¯¦ç»†å†…å®¹è¯·æŸ¥çœ‹åŸæ–‡'
                };
            } else {
                // è¾ƒé•¿å†…å®¹ï¼šå‰30ä¸ªå­—ç¬¦ä½œä¸ºæ ‡é¢˜ï¼Œå‰©ä½™ä½œä¸ºæè¿°
                return {
                    title: line.substring(0, 30).trim() + '...',
                    description: line.trim()
                };
            }
        }

        // æ™ºèƒ½åˆ†ç¦»æ ‡é¢˜å’Œå†…å®¹
        function intelligentTitleContentSplit(line) {
            // æ–¹æ³•1: æŸ¥æ‰¾é€—å·åˆ†å‰²ç‚¹ï¼ˆé€šå¸¸å…¬å¸å+åŠ¨ä½œåæœ‰é€—å·ï¼‰
            const commaMatch = line.match(/^([^ï¼Œ,]+[å…¬å¸|å‘å¸ƒ|æ¨å‡º|å®£å¸ƒ|å¯åŠ¨|å¼€æº|ä¸Šçº¿|æ›´æ–°|å‡çº§|ä¼˜åŒ–][^ï¼Œ,]*)[ï¼Œ,](.+)$/);
            if (commaMatch) {
                return {
                    title: commaMatch[1].trim(),
                    description: commaMatch[2].trim()
                };
            }
            
            // æ–¹æ³•2: æŸ¥æ‰¾å†’å·åˆ†å‰²ç‚¹
            const colonIndex = line.indexOf('ï¼š');
            if (colonIndex > 0 && colonIndex < line.length * 0.6) { // å†’å·åœ¨å‰60%ä½ç½®
                return {
                    title: line.substring(0, colonIndex).trim(),
                    description: line.substring(colonIndex + 1).trim()
                };
            }
            
            // æ–¹æ³•3: æŸ¥æ‰¾å¥å·åˆ†å‰²ç‚¹ï¼ˆç¬¬ä¸€å¥ä½œä¸ºæ ‡é¢˜ï¼‰
            const sentences = line.split(/[ã€‚ï¼ï¼Ÿ\.!?]/);
            if (sentences.length >= 2 && sentences[0].length > 10 && sentences[0].length < 80) {
                return {
                    title: sentences[0].trim() + 'ã€‚',
                    description: sentences.slice(1).join('').trim()
                };
            }
            
            // æ–¹æ³•4: æŸ¥æ‰¾ç‰¹å®šå…³é”®è¯åçš„å†…å®¹ä½œä¸ºæè¿°
            const keywordSplitPatterns = [
                /^([^ï¼Œ,]*(?:æ¨å‡º|å‘å¸ƒ|å®£å¸ƒ|å¯åŠ¨|å¼€æº|ä¸Šçº¿|æ›´æ–°|å‡çº§|ä¼˜åŒ–)[^ï¼Œ,]*)[ï¼Œ,]?(.+)$/,
                /^([^ï¼Œ,]*(?:å›¢é˜Ÿ|å…¬å¸|ç§‘æŠ€|AI)[^ï¼Œ,]*)[ï¼Œ,](.+)$/,
                /^([^ï¼Œ,]*(?:æ¨¡å‹|ç³»ç»Ÿ|å¹³å°|å·¥å…·|åº”ç”¨)[^ï¼Œ,]*)[ï¼Œ,](.+)$/
            ];
            
            for (let pattern of keywordSplitPatterns) {
                const match = line.match(pattern);
                if (match && match[1].length > 5 && match[1].length < 100) {
                    return {
                        title: match[1].trim(),
                        description: match[2] ? match[2].trim() : match[1].trim()
                    };
                }
            }
            
            // æ–¹æ³•5: æ™ºèƒ½é•¿åº¦åˆ†å‰²ï¼ˆå¦‚æœå†…å®¹å¾ˆé•¿ï¼‰
            if (line.length > 80) {
                // å¯»æ‰¾åˆé€‚çš„åˆ†å‰²ç‚¹ï¼ˆä¼˜å…ˆåœ¨å¥å­è¾¹ç•Œï¼‰
                let splitPoint = -1;
                const preferredLength = Math.min(60, line.length * 0.4);
                
                // åœ¨ä¼˜é€‰é•¿åº¦é™„è¿‘å¯»æ‰¾æ ‡ç‚¹ç¬¦å·
                for (let i = preferredLength - 10; i < preferredLength + 20 && i < line.length; i++) {
                    if (/[ï¼Œ,ã€‚ï¼ï¼Ÿ\.!?]/.test(line[i])) {
                        splitPoint = i;
                        break;
                    }
                }
                
                if (splitPoint > 0) {
                    return {
                        title: line.substring(0, splitPoint + 1).trim(),
                        description: line.substring(splitPoint + 1).trim()
                    };
                }
            }
            
            // é»˜è®¤æ–¹æ³•ï¼šçŸ­å†…å®¹ä½œä¸ºæ ‡é¢˜ï¼Œé•¿å†…å®¹åˆ†å‰²
            if (line.length <= 50) {
                return {
                    title: line,
                    description: line
                };
            } else {
                return {
                    title: line.substring(0, 50) + '...',
                    description: line
                };
            }
        }

        // æå–å…¬å¸åç§°
        function extractCompanyName(text) {
            const companies = [
                // AIç›¸å…³å…¬å¸
                'OpenAI', 'ChatGPT', 'Anthropic', 'Claude', 'xAI', 'Grok', 'Genspark',
                'DeepMind', 'Cohere', 'Stability AI', 'Midjourney', 'Runway',
                
                // ç§‘æŠ€å·¨å¤´
                'å¾®è½¯', 'Microsoft', 'è‹¹æœ', 'Apple', 'è°·æ­Œ', 'Google', 
                'Meta', 'Facebook', 'äºšé©¬é€Š', 'Amazon', 'Tesla', 'ç‰¹æ–¯æ‹‰',
                'è‹±ä¼Ÿè¾¾', 'NVIDIA', 'Intel', 'è‹±ç‰¹å°”', 'AMD',
                
                // ä¸­å›½ç§‘æŠ€å…¬å¸
                'åä¸º', 'Huawei', 'è…¾è®¯', 'Tencent', 'é˜¿é‡Œå·´å·´', 'Alibaba',
                'ç™¾åº¦', 'Baidu', 'å­—èŠ‚è·³åŠ¨', 'ByteDance', 'å°ç±³', 'Xiaomi',
                'äº¬ä¸œ', 'JD', 'ç¾å›¢', 'Meituan', 'æ»´æ»´', 'Didi', 'æ‹¼å¤šå¤š',
                'å°çº¢ä¹¦', 'æŠ–éŸ³', 'TikTok', 'å¿«æ‰‹', 'å“”å“©å“”å“©', 'Bç«™',
                'å•†æ±¤', 'SenseTime', 'æ—·è§†', 'Face++', 'ä¾å›¾', 'äº‘ä»',
                'å®‡æ ‘ç§‘æŠ€', 'ç§‘å¤§è®¯é£', 'iFlytek', 'æœç‹—', 'Sogou',
                
                // ç¡¬ä»¶åˆ¶é€ å•†
                'SKæµ·åŠ›å£«', 'SK Hynix', 'å°ç§¯ç”µ', 'TSMC', 'ä¸‰æ˜Ÿ', 'Samsung',
                'è”æƒ³', 'Lenovo', 'æˆ´å°”', 'Dell', 'HP', 'æƒ æ™®', 'IBM',
                'å®å¾·æ—¶ä»£', 'CATL', 'æ¯”äºšè¿ª', 'BYD', 'ç†æƒ³', 'è”šæ¥', 'NIO',
                'å°é¹', 'XPeng', 'å¨é©¬', 'WM Motor',
                
                // è½¯ä»¶å’ŒæœåŠ¡
                'GitHub', 'GitLab', 'Adobe', 'Salesforce', 'Slack',
                'Netflix', 'Spotify', 'Uber', 'Airbnb', 'Zoom',
                'Discord', 'Reddit', 'Twitter', 'X', 'LinkedIn',
                
                // é‡‘èæœºæ„
                'æ‘©æ ¹å¤§é€š', 'JPMorgan', 'é«˜ç››', 'Goldman Sachs', 'ç¾è”å‚¨', 'Fed',
                'ä¸­å›½é“¶è¡Œ', 'å·¥å•†é“¶è¡Œ', 'å»ºè®¾é“¶è¡Œ', 'å†œä¸šé“¶è¡Œ', 'æ‹›å•†é“¶è¡Œ',
                'æ”¯ä»˜å®', 'Alipay', 'å¾®ä¿¡æ”¯ä»˜', 'WeChat Pay', 'æ¯”ç‰¹å¸', 'Bitcoin',
                
                // ä¼ ç»Ÿä¼ä¸šå’Œåˆ¶é€ ä¸š
                'é€šç”¨æ±½è½¦', 'GM', 'ç¦ç‰¹', 'Ford', 'ä¸°ç”°', 'Toyota', 'å¤§ä¼—', 'Volkswagen',
                'æ³¢éŸ³', 'Boeing', 'ç©ºå®¢', 'Airbus', 'åŸƒå…‹æ£®ç¾å­š', 'ExxonMobil',
                'æ²ƒå°”ç›', 'Walmart', 'äºšé©¬é€Š', 'Amazon', 'å¯å£å¯ä¹', 'Coca-Cola',
                'éº¦å½“åŠ³', 'McDonald', 'æ˜Ÿå·´å…‹', 'Starbucks', 'è€å…‹', 'Nike',
                'å®‰è¸', 'ANTA', 'æå®', 'Li-Ning', 'ä¸­çŸ³æ²¹', 'ä¸­çŸ³åŒ–',
                
                // æ”¿åºœæœºæ„å’Œå›½é™…ç»„ç»‡
                'ç‰¹æœ—æ™®', 'Trump', 'æ‹œç™»', 'Biden', 'ç™½å®«', 'White House',
                'å›½åŠ¡é™¢', 'å¤–äº¤éƒ¨', 'å•†åŠ¡éƒ¨', 'è´¢æ”¿éƒ¨', 'å¤®è¡Œ',
                'è”åˆå›½', 'UN', 'ä¸–ç•Œé“¶è¡Œ', 'World Bank', 'IMF', 'å›½é™…è´§å¸åŸºé‡‘ç»„ç»‡',
                'æ¬§ç›Ÿ', 'EU', 'åŒ—çº¦', 'NATO', 'ä¸–è´¸ç»„ç»‡', 'WTO',
                'ä»¥è‰²åˆ—', 'Israel', 'å·´å‹’æ–¯å¦', 'Palestine', 'ç¾å›½', 'ä¸­å›½', 'ä¿„ç½—æ–¯',
                'è‹±å›½', 'æ³•å›½', 'å¾·å›½', 'æ—¥æœ¬', 'éŸ©å›½', 'å°åº¦',
                
                // åª’ä½“å’Œå¨±ä¹
                'CNN', 'BBC', 'æ–°åç¤¾', 'äººæ°‘æ—¥æŠ¥', 'åå°”è¡—æ—¥æŠ¥', 'çº½çº¦æ—¶æŠ¥',
                'è¿ªå£«å°¼', 'Disney', 'åçº³', 'Warner', 'ç¯çƒ', 'Universal',
                'Netflix', 'Hulu', 'çˆ±å¥‡è‰º', 'ä¼˜é…·', 'è…¾è®¯è§†é¢‘',
                
                // åŒ»ç–—å’Œç”Ÿç‰©æŠ€æœ¯
                'è¾‰ç‘', 'Pfizer', 'å¼ºç”Ÿ', 'Johnson & Johnson', 'é»˜å…‹', 'Merck',
                'æ‹œè€³', 'Bayer', 'è¯ºå', 'Novartis', 'ç½—æ°', 'Roche',
                
                // èƒ½æºå’Œç¯ä¿
                'ä¸­æµ·æ²¹', 'å›½å®¶ç”µç½‘', 'å—æ–¹ç”µç½‘', 'ä¸‰å³¡é›†å›¢',
                'å£³ç‰Œ', 'Shell', 'BP', 'é›ªä½›é¾™', 'Chevron',
                
                // å…¶ä»–çŸ¥åæœºæ„
                'FireRed', 'UnifoLM', 'Codex', 'è­¦æ–¹', 'æ³•é™¢', 'æ£€å¯Ÿé™¢',
                'å¤®è§†', 'CCTV', 'å®‰å…¨å±€', 'ç¨åŠ¡å±€', 'å·¥å•†å±€'
            ];
            
            // æŸ¥æ‰¾æ‰€æœ‰å‡ºç°çš„å…¬å¸
            const foundCompanies = [];
            for (const company of companies) {
                if (text.includes(company)) {
                    foundCompanies.push(company);
                }
            }
            
            // å¦‚æœæ‰¾åˆ°å¤šä¸ªå…¬å¸ï¼Œç”¨"å’Œ"è¿æ¥
            if (foundCompanies.length > 1) {
                return foundCompanies.slice(0, 3).join('ã€'); // æœ€å¤šæ˜¾ç¤º3ä¸ªå…¬å¸
            } else if (foundCompanies.length === 1) {
                return foundCompanies[0];
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å·²çŸ¥å…¬å¸ï¼Œå°è¯•æå–å¯èƒ½çš„å…¬å¸å
            const companyPattern = /([A-Za-z\u4e00-\u9fa5]+[å…¬å¸|ç§‘æŠ€|é›†å›¢|Corp|Inc|Ltd|LLC])/g;
            const matches = text.match(companyPattern);
            if (matches && matches.length > 0) {
                return matches.slice(0, 2).join('ã€'); // æœ€å¤šæ˜¾ç¤º2ä¸ª
            }
            
            return 'æœªçŸ¥å…¬å¸';
        }

        // æ™ºèƒ½æ¨æµ‹æ ‡ç­¾
        function predictTag(text) {
            const tagKeywords = {
                'ai': {
                    keywords: [
                        // åŸºç¡€AIå…³é”®è¯
                        'AI', 'äººå·¥æ™ºèƒ½', 'æœºå™¨å­¦ä¹ ', 'æ·±åº¦å­¦ä¹ ', 'ç¥ç»ç½‘ç»œ', 'å¤§æ¨¡å‹', 'è¯­è¨€æ¨¡å‹',
                        // å…·ä½“AIäº§å“
                        'GPT', 'ChatGPT', 'Claude', 'Grok', 'Codex', 'Agent', 'LLM', 'TTS',
                        // AIå…¬å¸å’ŒæŠ€æœ¯
                        'OpenAI', 'Anthropic', 'xAI', 'Genspark', 'FireRed', 'UnifoLM',
                        // AIåº”ç”¨
                        'æ™ºèƒ½åŠ©æ‰‹', 'æ™ºèƒ½åˆæˆ', 'éŸ³é¢‘åˆæˆ', 'å¯¹è¯åˆæˆ', 'éŸ³è‰²å…‹éš†', 'ä»£ç ç”Ÿæˆ',
                        'ä¸–ç•Œæ¨¡å‹', 'ç‰©ç†äº¤äº’', 'ç¼–ç Agent', 'æ€è€ƒæ—¶é—´', 'åŸºå‡†æµ‹è¯•'
                    ],
                    weight: 4
                },
                'hardware': {
                    keywords: [
                        'èŠ¯ç‰‡', 'å¤„ç†å™¨', 'å†…å­˜', 'CPU', 'GPU', 'ç¡¬ä»¶', 'è®¾å¤‡', 'HBM', 
                        'å­˜å‚¨å™¨', 'åŠå¯¼ä½“', 'æ˜¾å¡', 'L20', 'å»¶è¿Ÿ', 'å“åº”é€Ÿåº¦', 'æ€§èƒ½',
                        'ç®—åŠ›', 'è®¡ç®—', 'æœåŠ¡å™¨', 'è¾¹ç¼˜è®¡ç®—'
                    ],
                    weight: 3
                },
                'mobile': {
                    keywords: [
                        'æ‰‹æœº', 'iPhone', 'Android', 'ç§»åŠ¨', 'App', 'åº”ç”¨', 'ç§»åŠ¨ç«¯', 
                        'æ™ºèƒ½æ‰‹æœº', 'iOS', 'å°ç¨‹åº', 'ç§»åŠ¨è®¾å¤‡', 'APP'
                    ],
                    weight: 2
                },
                'security': {
                    keywords: [
                        'å®‰å…¨', 'éšç§', 'åŠ å¯†', 'é˜²æŠ¤', 'æ¼æ´', 'æ”»å‡»', 'ç½‘ç»œå®‰å…¨', 
                        'æ•°æ®å®‰å…¨', 'é˜²ç«å¢™', 'è®¤è¯', 'æƒé™', 'åˆè§„'
                    ],
                    weight: 2
                },
                'web': {
                    keywords: [
                        'ç½‘ç«™', 'æµè§ˆå™¨', 'Web', 'äº’è”ç½‘', 'åœ¨çº¿', 'ç½‘ç»œ', 'æœç´¢', 'ç½‘é¡µ',
                        'æœ¬åœ°è¿è¡Œ', 'ç¦»çº¿è¿è¡Œ', 'å¼€æºæ¨¡å‹', 'æœ¬åœ°æ¨¡å‹', 'æµè§ˆå™¨ç«¯'
                    ],
                    weight: 2
                },
                'design': {
                    keywords: [
                        'è®¾è®¡', 'UI', 'UX', 'ç•Œé¢', 'ç”¨æˆ·ä½“éªŒ', 'è§†è§‰', 'äº¤äº’', 
                        'åˆ›æ„', 'è®¾è®¡å·¥å…·', 'åŸå‹', 'ç•Œé¢è®¾è®¡'
                    ],
                    weight: 2
                },
                'politics': {
                    keywords: [
                        'æ”¿æ²»', 'æ”¿åºœ', 'æ€»ç»Ÿ', 'æ€»ç†', 'å›½åŠ¡é™¢', 'å¤–äº¤éƒ¨', 'å¤§ä½¿é¦†',
                        'ç‰¹æœ—æ™®', 'æ‹œç™»', 'ç™½å®«', 'å›½ä¼š', 'è®®ä¼š', 'é€‰ä¸¾', 'æŠ•ç¥¨',
                        'å¤–äº¤', 'ä¼šè°ˆ', 'è®¿é—®', 'ä¼šè®®', 'å³°ä¼š', 'åè®®', 'æ¡çº¦',
                        'åˆ¶è£', 'è°ˆåˆ¤', 'æ”¿ç­–', 'æ³•æ¡ˆ', 'æ³•å¾‹'
                    ],
                    weight: 3
                },
                'finance': {
                    keywords: [
                        'è‚¡å¸‚', 'è‚¡ç¥¨', 'é‡‘è', 'é“¶è¡Œ', 'æŠ•èµ„', 'åŸºé‡‘', 'è¯åˆ¸',
                        'æ”¶ç›˜', 'ä¸Šæ¶¨', 'ä¸‹è·Œ', 'æ¶¨å¹…', 'è·Œå¹…', 'å¸‚å€¼', 'èèµ„',
                        'IPO', 'ä¸Šå¸‚', 'è´¢æŠ¥', 'è¥æ”¶', 'åˆ©æ¶¦', 'ç»æµ', 'GDP',
                        'è´§å¸', 'æ±‡ç‡', 'ç¾å…ƒ', 'äººæ°‘å¸', 'æ¬§å…ƒ', 'åˆ©ç‡',
                        'æ¯”ç‰¹å¸', 'æ•°å­—è´§å¸', 'åŒºå—é“¾', 'åŠ å¯†è´§å¸'
                    ],
                    weight: 3
                },
                'military': {
                    keywords: [
                        'å†›äº‹', 'å†›é˜Ÿ', 'æˆ˜äº‰', 'å†²çª', 'è¢­å‡»', 'å¯¼å¼¹', 'è½°ç‚¸',
                        'ä»¥è‰²åˆ—', 'ä»¥å†›', 'å·´å‹’æ–¯å¦', 'åŠ æ²™', 'å“ˆé©¬æ–¯', 'çœŸä¸»å…š',
                        'ä¿„ä¹Œ', 'ä¹Œå…‹å…°', 'ä¿„ç½—æ–¯', 'åŒ—çº¦', 'å†›æ¼”', 'åˆ¶è£',
                        'å®‰å…¨', 'é˜²åŠ¡', 'æ­¦å™¨', 'å†›å¤‡', 'æ’¤ç¦»', 'è­¦å‘Š'
                    ],
                    weight: 3
                },
                'business': {
                    keywords: [
                        'ä¼ä¸š', 'å…¬å¸', 'å•†ä¸š', 'å¸‚åœº', 'é”€å”®', 'è¥é”€', 'å“ç‰Œ',
                        'åˆä½œ', 'åˆå¹¶', 'æ”¶è´­', 'é‡ç»„', 'è‘£äº‹', 'CEO', 'æ€»è£',
                        'ä¸šç»©', 'è´¢åŠ¡', 'æŠ¥å‘Š', 'å‘å¸ƒ', 'æ¨å‡º', 'ä¸Šçº¿', 'å‡çº§'
                    ],
                    weight: 2
                },
                'social': {
                    keywords: [
                        'ç¤¾ä¼š', 'æ°‘ä¼—', 'æŠ—è®®', 'ç¤ºå¨', 'æ¸¸è¡Œ', 'ç½¢å·¥', 'äº‹æ•…',
                        'ç¾å®³', 'åœ°éœ‡', 'å°é£', 'æ´ªæ°´', 'ç«ç¾', 'äº‹ä»¶', 'æ¡ˆä»¶',
                        'è¯ˆéª—', 'çŠ¯ç½ª', 'è­¦æ–¹', 'è°ƒæŸ¥', 'é€®æ•', 'æ³•é™¢', 'åˆ¤å†³'
                    ],
                    weight: 2
                },
                'sports': {
                    keywords: [
                        'ä½“è‚²', 'è¿åŠ¨', 'æ¯”èµ›', 'èµ›äº‹', 'è¶³çƒ', 'ç¯®çƒ', 'ç½‘çƒ',
                        'å¥¥è¿', 'ä¸–ç•Œæ¯', 'è”èµ›', 'çƒå‘˜', 'æ•™ç»ƒ', 'å† å†›', 'èƒœåˆ©',
                        'å¥³æ’', 'ç”·è¶³', 'æ¸¸æ³³', 'ç”°å¾„', 'ä½“æ“'
                    ],
                    weight: 2
                },
                'entertainment': {
                    keywords: [
                        'å¨±ä¹', 'ç”µå½±', 'ç”µè§†', 'æ˜æ˜Ÿ', 'æ¼”å‘˜', 'å¯¼æ¼”', 'éŸ³ä¹',
                        'ç»¼è‰º', 'èŠ‚ç›®', 'æ¼”å‡º', 'éŸ³ä¹ä¼š', 'æ¼”å”±ä¼š', 'ç¥¨æˆ¿',
                        'é¢„å‘Š', 'é¦–æ˜ ', 'ä¸Šæ˜ ', 'æ’­å‡º', 'æ”¶è§†ç‡'
                    ],
                    weight: 2
                },
                'weather': {
                    keywords: [
                        'å¤©æ°”', 'æ°”è±¡', 'é™é›ª', 'é™æ¸©', 'å†·ç©ºæ°”', 'å°é£', 'æš´é›¨',
                        'é«˜æ¸©', 'ä½æ¸©', 'æ°”æ¸©', 'æ¸©åº¦', 'æ°”å€™', 'é¢„æŠ¥', 'è­¦æŠ¥'
                    ],
                    weight: 2
                },
                'tech': {
                    keywords: [
                        'ç§‘æŠ€', 'æŠ€æœ¯', 'å¼€å‘', 'è½¯ä»¶', 'ç¨‹åº', 'ä»£ç ', 'ç¼–ç¨‹', 
                        'åˆä½œ', 'å‘å¸ƒ', 'æ¨å‡º', 'æ›´æ–°', 'å‡çº§', 'ä¼˜åŒ–', 'å¼€æº',
                        'å¹³å°', 'ç³»ç»Ÿ', 'å·¥å…·', 'æ¡†æ¶', 'æ¶æ„', 'æŒ‡å—', 'è¯„ä¼°'
                    ],
                    weight: 1
                }
            };
            
            // è®¡ç®—æ¯ä¸ªæ ‡ç­¾çš„å¾—åˆ†
            const scores = {};
            
            for (const [tag, config] of Object.entries(tagKeywords)) {
                scores[tag] = 0;
                for (const keyword of config.keywords) {
                    if (text.includes(keyword)) {
                        scores[tag] += config.weight;
                    }
                }
            }
            
            // æ‰¾åˆ°å¾—åˆ†æœ€é«˜çš„æ ‡ç­¾
            let maxScore = 0;
            let bestTag = 'tech';
            
            for (const [tag, score] of Object.entries(scores)) {
                if (score > maxScore) {
                    maxScore = score;
                    bestTag = tag;
                }
            }
            
            // ç‰¹æ®Šè§„åˆ™ï¼šå¦‚æœåŒ…å«ç‰¹å®šçš„AIå…³é”®è¯ï¼Œä¼˜å…ˆåˆ¤å®šä¸ºAI
            const strongAIKeywords = ['GPT', 'ChatGPT', 'OpenAI', 'å¤§æ¨¡å‹', 'è¯­è¨€æ¨¡å‹'];
            const hasStrongAI = strongAIKeywords.some(keyword => text.includes(keyword));
            
            // ç‰¹æ®Šè§„åˆ™ï¼šå¦‚æœæ˜¯åˆä½œã€æŠ€æœ¯è¿›æ­¥ç­‰ï¼Œä¸”æ²¡æœ‰å¼ºAIç‰¹å¾ï¼Œåˆ¤å®šä¸ºç§‘æŠ€
            const techCollabKeywords = ['åˆä½œ', 'æ·±åŒ–åˆä½œ', 'æŠ€æœ¯è¿›æ­¥', 'æ¨åŠ¨', 'è¿›ä¸€æ­¥'];
            const hasTechCollab = techCollabKeywords.some(keyword => text.includes(keyword));
            
            if (hasStrongAI) {
                return 'ai';
            } else if (hasTechCollab && !hasStrongAI && maxScore <= 2) {
                return 'tech';
            }
            
            return bestTag;
        }

        // æ·»åŠ å¸¦æ•°æ®çš„æ–°é—»æ¡ç›®
        function addNewsItemWithData(newsData) {
            newsItemCount++;
            const container = document.getElementById('newsItems');
            
            const newsItem = document.createElement('div');
            newsItem.className = 'news-item';
            newsItem.dataset.index = newsItemCount;
            
            newsItem.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeNewsItem(${newsItemCount})">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label">æ ‡é¢˜</label>
                        <input type="text" class="form-control news-title" 
                               value="${newsData.title}" placeholder="è¯·è¾“å…¥æ–°é—»æ ‡é¢˜">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">å…¬å¸/æœºæ„</label>
                        <input type="text" class="form-control news-company" 
                               value="${newsData.company}" placeholder="è¯·è¾“å…¥å…¬å¸åç§°">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">æè¿°</label>
                    <textarea class="form-control news-description" rows="3" 
                              placeholder="è¯·è¾“å…¥æ–°é—»æè¿°">${newsData.description}</textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">æ ‡ç­¾ç±»å‹</label>
                    <div class="tag-selector">
                        ${Object.entries(newsTags).map(([key, tag]) => 
                            `<div class="tag-option ${key === newsData.tag ? 'selected' : ''}" data-tag="${key}">
                                <i class="fas ${tag.icon}"></i> ${tag.name}
                             </div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            container.appendChild(newsItem);
            
            // è®¾ç½®æ ‡ç­¾é€‰æ‹©å™¨
            const tagOptions = newsItem.querySelectorAll('.tag-option');
            tagOptions.forEach(option => {
                option.addEventListener('click', () => {
                    tagOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        }

        // æ¸…ç©ºæ‰€æœ‰æ–°é—»
        function clearAllNews() {
            const container = document.getElementById('newsItems');
            container.innerHTML = '';
            newsItemCount = 0;
        }

        // é¢„è§ˆç”ŸæˆåŠŸèƒ½
        function setupPreviewGeneration() {
            document.getElementById('generatePreview').addEventListener('click', generatePreview);
        }

        function generatePreview() {
            const reportData = collectFormData();
            
            if (!reportData.report_name.trim()) {
                alert('è¯·è¾“å…¥æ—¥æŠ¥åç§°');
                return;
            }
            
            if (reportData.news_items.length === 0) {
                alert('è¯·æ·»åŠ è‡³å°‘ä¸€æ¡æ–°é—»');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.getElementById('loading').style.display = 'block';
            document.getElementById('previewSection').style.display = 'none';

            fetch('/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reportData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                
                if (data.success) {
                    generatedHtml = data.html;
                    const iframe = document.getElementById('previewIframe');
                    iframe.srcdoc = generatedHtml;
                    document.getElementById('previewSection').style.display = 'block';
                    document.getElementById('exportImage').disabled = false;
                } else {
                    alert('ç”Ÿæˆå¤±è´¥ï¼š' + data.error);
                }
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';
                console.error('ç”Ÿæˆé”™è¯¯:', error);
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // å›¾ç‰‡å¯¼å‡ºåŠŸèƒ½
        function setupImageExport() {
            document.getElementById('exportImage').addEventListener('click', exportImage);
        }

        function exportImage() {
            if (!generatedHtml) {
                alert('è¯·å…ˆç”Ÿæˆé¢„è§ˆ');
                return;
            }

            const exportBtn = document.getElementById('exportImage');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆå›¾ç‰‡ä¸­...';
            exportBtn.disabled = true;

            // åˆ›å»ºä¸´æ—¶çš„iframeæ¥æ¸²æŸ“HTML
            const iframe = document.createElement('iframe');
            iframe.style.position = 'absolute';
            iframe.style.left = '-9999px';
            iframe.style.width = '750px';
            iframe.style.height = '800px';
            document.body.appendChild(iframe);

            // å†™å…¥HTMLå†…å®¹
            iframe.contentDocument.write(generatedHtml);
            iframe.contentDocument.close();

            // ç­‰å¾…iframeåŠ è½½å®Œæˆ
            iframe.onload = function() {
                setTimeout(() => {
                    // ä½¿ç”¨html2canvasæˆªå›¾iframeå†…å®¹
                    html2canvas(iframe.contentDocument.body, {
                        scale: 2, // é«˜è´¨é‡
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#f5f7fa',
                        width: 750,
                        height: iframe.contentDocument.body.scrollHeight,
                        scrollX: 0,
                        scrollY: 0
                    }).then(canvas => {
                        // è½¬æ¢ä¸ºå›¾ç‰‡å¹¶ä¸‹è½½
                        const imgData = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.download = `æ—¥æŠ¥_${new Date().toISOString().slice(0, 10)}_${new Date().toTimeString().slice(0, 8).replace(/:/g, '')}.png`;
                        link.href = imgData;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // æ¸…ç†iframe
                        document.body.removeChild(iframe);
                        
                        // æ¢å¤æŒ‰é’®
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                        
                        alert('âœ… å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹');
                        
                    }).catch(error => {
                        console.error('æˆªå›¾å¤±è´¥:', error);
                        document.body.removeChild(iframe);
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                        alert('âŒ å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                }, 1000); // ç­‰å¾…1ç§’ç¡®ä¿å†…å®¹å®Œå…¨æ¸²æŸ“
            };
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const reportName = document.getElementById('reportName').value.trim();
            const signature = document.getElementById('signature').value.trim();
            const showCreator = document.getElementById('showCreator').checked;
            
            // æ”¶é›†æ–°é—»æ¡ç›®
            const newsItems = [];
            const newsElements = document.querySelectorAll('.news-item');
            
            newsElements.forEach(item => {
                const title = item.querySelector('.news-title').value.trim();
                const company = item.querySelector('.news-company').value.trim();
                const description = item.querySelector('.news-description').value.trim();
                const selectedTag = item.querySelector('.tag-option.selected');
                
                if (title && description) {
                    newsItems.push({
                        title: title,
                        company: company || 'æœªçŸ¥å…¬å¸',
                        description: description,
                        tag: selectedTag ? selectedTag.dataset.tag : 'tech'
                    });
                }
            });

            // æ”¶é›†é¢œè‰²è®¾ç½®
            let colorConfig = {};
            if (currentTheme === 'custom') {
                const primary = document.getElementById('customPrimary').value;
                const secondary = document.getElementById('customSecondary').value;
                const accent = document.getElementById('customAccent').value;
                
                colorConfig = {
                    primary: primary,
                    secondary: secondary,
                    accent: accent,
                    header_gradient: `linear-gradient(135deg, ${primary} 0%, ${secondary} 100%)`,
                    footer_gradient: `linear-gradient(135deg, ${secondary} 0%, ${primary} 100%)`
                };
            }

            return {
                report_name: reportName,
                logo_data: currentLogo,
                color_theme: currentTheme,
                custom_colors: colorConfig,
                news_items: newsItems,
                signature: signature,
                show_creator: showCreator
            };
        }
    </script>
</body>
</html>
